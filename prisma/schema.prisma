generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ABM
  ASE
  ZBM
  ZSE
  SEC
  SAMSUNG_ADMINISTRATOR
  ZOPPER_ADMINISTRATOR
}

enum Validation {
  APPROVED
  PENDING
  BLOCKED
}

enum PlanType {
  SCREEN_PROTECT_1_YR
  ADLD_1_YR
  COMBO_2_YRS
  EXTENDED_WARRANTY_1_YR
  TEST_PLAN
}

model Store {
  id    String  @id @map("_id")
  name  String
  city  String?
  state String?

  salesReports           SalesReport[]
  spotIncentiveCampaigns SpotIncentiveCampaign[]
  secUsers              SEC[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SamsungSKU {
  id                     String                  @id @default(auto()) @map("_id") @db.ObjectId
  Category               String
  ModelName              String
  plans                  Plan[]
  salesReports           SalesReport[]
  spotIncentiveCampaigns SpotIncentiveCampaign[]

  @@map("SamsungSKU")
}

model Plan {
  id                     String                  @id @default(auto()) @map("_id") @db.ObjectId
  planType               PlanType
  price                  Int
  samsungSKU             SamsungSKU?             @relation(fields: [samsungSKUId], references: [id])
  samsungSKUId           String?                 @db.ObjectId
  salesReports           SalesReport[]
  spotIncentiveCampaigns SpotIncentiveCampaign[]

  @@map("Plan")
}

model SalesReport {
  id                      String                 @id @default(auto()) @map("_id") @db.ObjectId
  secId                   String                 @db.ObjectId
  secUser                 SEC                    @relation(fields: [secId], references: [id])
  storeId                 String
  store                   Store                  @relation(fields: [storeId], references: [id])
  samsungSKUId            String                 @db.ObjectId
  samsungSKU              SamsungSKU             @relation(fields: [samsungSKUId], references: [id])
  planId                  String                 @db.ObjectId
  plan                    Plan                   @relation(fields: [planId], references: [id])
  imei                    String
  salesSummaryId          String?                @db.ObjectId
  SalesSummary            SalesSummary?          @relation("SalesSummaryReports", fields: [salesSummaryId], references: [id])
  spotIncentiveCampaignId String?                @db.ObjectId
  spotIncentiveCampaign   SpotIncentiveCampaign? @relation(fields: [spotIncentiveCampaignId], references: [id])
  spotincentiveEarned     Int // Calculated incentive amount
  voucherCode             String? // Optional voucher code for incentive redemption
  spotincentivepaidAt     DateTime? //paid for each sale
  metadata                Json? // Additional data related to the sales report
  submittedAt             DateTime               @default(now())
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt

  @@unique([imei])
  @@index([secId])
  @@index([storeId])
  @@index([submittedAt])
  @@index([spotIncentiveCampaignId])
}

model SalesSummary {
  id                          String        @id @default(auto()) @map("_id") @db.ObjectId
  secId                       String        @db.ObjectId
  secUser                     SEC           @relation(fields: [secId], references: [id])
  totalSpotIncentiveEarned    Int
  totalSamsungIncentiveEarned Int? // Optional - decided at payment date
  samsungincentivepaidAt      DateTime? //paid for  monthly sale
  metadata                    Json? // Additional data related to the sales summary
  salesReport                 SalesReport[] @relation("SalesSummaryReports")
  month                       Int
  year                        Int
  createdAt                   DateTime      @default(now())
  updatedAt                   DateTime      @updatedAt

  @@index([secId])
  @@index([month, year])
}

enum IncentiveType {
  FIXED // fixed amount per sale, e.g., 200 (INR)
  PERCENTAGE // percent of sale or plan price, e.g., 5 = 5%
}

model SpotIncentiveCampaign {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  description  String?
  // targeting (nullable -> if null that axis is "all")
  store        Store      @relation(fields: [storeId], references: [id])
  storeId      String // Store uses String IDs, not ObjectId
  samsungSKU   SamsungSKU @relation(fields: [samsungSKUId], references: [id])
  samsungSKUId String     @db.ObjectId
  plan         Plan       @relation(fields: [planId], references: [id])
  planId       String     @db.ObjectId

  // incentive details
  incentiveType  IncentiveType @default(FIXED)
  incentiveValue Float // use Float or Decimal depending on your connector; stores amount or percent

  // schedule + status
  startDate DateTime
  endDate   DateTime
  active    Boolean  @default(true)

  // relationships
  salesReports SalesReport[] @relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Prevent duplicate exact campaigns for same triple and overlapping time (optional unique index is tricky with ranges).
  @@index([storeId])
  @@index([samsungSKUId])
  @@index([planId])
  @@map("Campaign")
}

model User {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  username String @unique
  password String
  role     Role

  // admin-based approval status for this user (PENDING by default, APPROVED/BLOCKED set by admin)
  validation Validation @default(PENDING)

  // all signup form fields except username, password and role (store mapping + user mapping)
  metadata Json?

  abmProfile          ABM?          @relation("UserABM")
  aseProfile          ASE?          @relation("UserASE")
  zbmProfile          ZBM?          @relation("UserZBM")
  zseProfile          ZSE?          @relation("UserZSE")
  samsungAdminProfile SamsungAdmin? @relation("UserSamsungAdmin")
  zopperAdminProfile  ZopperAdmin?  @relation("UserZopperAdmin")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ABM {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  storeIds String[]
  zbmId    String   @db.ObjectId

  user User @relation("UserABM", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ASE {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  storeIds String[]
  zseId    String   @db.ObjectId

  user User @relation("UserASE", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ZBM {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  region String?

  user User @relation("UserZBM", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ZSE {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  region String?

  user User @relation("UserZSE", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SEC {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  fullName    String?
  phone       String    @unique
  email       String?   @unique
  lastLoginAt DateTime?
  storeId   String?
  store     Store?    @relation(fields: [storeId], references: [id])
  AgencyName   String?
  AgentCode String?
  salesReports   SalesReport[]
  salesSummaries SalesSummary[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Otp {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  phone     String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
}

model SamsungAdmin {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  user User @relation("UserSamsungAdmin", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ZopperAdmin {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  user User @relation("UserZopperAdmin", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClaimProcedurePDF {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  fileName    String
  fileSize    Int
  fileData    String // Base64 encoded PDF data
  category    String   @default("GENERAL")
  isActive    Boolean  @default(true)
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}
