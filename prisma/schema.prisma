generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ABM
  ASE
  ZBM
  ZSM
  SEC
  SAMSUNG_ADMINISTRATOR
  ZOPPER_ADMINISTRATOR
}

enum Validation {
  APPROVED
  PENDING
  BLOCKED
}

enum PlanType {
  SCREEN_PROTECT_1_YR
  ADLD_1_YR
  COMBO_2_YRS
  EXTENDED_WARRANTY_1_YR
  TEST_PLAN
}

model Store {
  id    String  @id @map("_id")
  name  String
  city  String?
  state String?
  periodicAttachRates periodicAttachRate[]
  samsungIncentiveInfo Json?  // Array<Object>: { month: String(MM-YYYY), samsungIncentiveAmount: Int, samsungIncentivePaidAt: Date | null }    
  dailyIncentiveReports   DailyIncentiveReport[]
  spotIncentiveReports           SpotIncentiveReport[]
  spotIncentiveCampaigns  SpotIncentiveCampaign[]
  secUsers                SEC[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model periodicAttachRate {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  storeId   String   @unique // Each store can have only one attach rate record
  store     Store    @relation(fields: [storeId], references: [id])
  start    String   // e.g., "01-01-2024", "dd-mm-yyyy". inclusive of this period
  end      String   // e.g., "31-03-2024", "dd-mm-yyyy". inclusive of this period
  attachPercentage Float    // e.g., 25%
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SamsungSKU {
  id                     String                  @id @default(auto()) @map("_id") @db.ObjectId
  Category               String
  ModelName              String
  ModelPrice             Int?
  plans                  Plan[]
  SpotIncentiveReport           SpotIncentiveReport[]
  dailyIncentiveReports       DailyIncentiveReport[]
  spotIncentiveCampaigns SpotIncentiveCampaign[]
  @@map("SamsungSKU")
}

model Plan {
  id                     String                  @id @default(auto()) @map("_id") @db.ObjectId
  planType               PlanType
  price                  Int
  samsungSKU             SamsungSKU?             @relation(fields: [samsungSKUId], references: [id])
  samsungSKUId           String?                 @db.ObjectId
  dailyIncentiveReports           DailyIncentiveReport[]
  SpotIncentiveReport           SpotIncentiveReport[]
  spotIncentiveCampaigns SpotIncentiveCampaign[]

  @@map("Plan")
}

model SpotIncentiveReport {
  id                      String                 @id @default(auto()) @map("_id") @db.ObjectId
  secId                   String                 @db.ObjectId
  secUser                 SEC                    @relation(fields: [secId], references: [id])
  storeId                 String
  store                   Store                  @relation(fields: [storeId], references: [id])
  samsungSKUId            String                 @db.ObjectId
  samsungSKU              SamsungSKU             @relation(fields: [samsungSKUId], references: [id])
  planId                  String                 @db.ObjectId
  salesSummaryid          String?                @db.ObjectId
  plan                    Plan                   @relation(fields: [planId], references: [id])
  imei                    String
  isCompaignActive        Boolean                @default(false)
  spotincentiveEarned     Int                    @default(0) // Calculated incentive amount
  voucherCode             String? // Optional voucher code for incentive redemption
  spotincentivepaidAt     DateTime? //paid for each sale
  metadata                Json? // Additional data related to the sales report
  Date_of_sale            DateTime          
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt

  @@unique([imei])
  @@index([secId])
  @@index([storeId])
  @@index([Date_of_sale])
}

model DailyIncentiveReport {
  id                      String                 @id @default(auto()) @map("_id") @db.ObjectId
  secId                   String?                 @db.ObjectId
  secUser                 SEC?                    @relation(fields: [secId], references: [id])
  storeId                 String
  store                   Store                  @relation(fields: [storeId], references: [id])
  samsungSKUId            String                 @db.ObjectId
  samsungSKU              SamsungSKU             @relation(fields: [samsungSKUId], references: [id])
  planId                  String                 @db.ObjectId
  plan                    Plan                   @relation(fields: [planId], references: [id])
  imei                    String
  metadata                Json? // Additional data related to the sales report
  Date_of_sale            DateTime           
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt

  @@unique([imei])
  @@index([secId])
  @@index([storeId])
  @@index([Date_of_sale])
}


enum IncentiveType {
  FIXED // fixed amount per sale, e.g., 200 (INR)
  PERCENTAGE // percent of sale or plan price, e.g., 5 = 5%
}

model SpotIncentiveCampaign {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  name         String?
  description  String?
  // targeting (nullable -> if null that axis is "all")
  store        Store      @relation(fields: [storeId], references: [id])
  storeId      String // Store uses String IDs, not ObjectId
  samsungSKU   SamsungSKU @relation(fields: [samsungSKUId], references: [id])
  samsungSKUId String     @db.ObjectId
  plan         Plan       @relation(fields: [planId], references: [id])
  planId       String     @db.ObjectId

  // incentive details
  incentiveType  IncentiveType? @default(FIXED)
  incentiveValue Float // use Float or Decimal depending on your connector; stores amount or percent

  // schedule + status
  startDate DateTime?
  endDate   DateTime?
  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Prevent duplicate exact campaigns for same triple and overlapping time (optional unique index is tricky with ranges).
  @@index([storeId])
  @@index([samsungSKUId])
  @@index([planId])
  @@map("Campaign")
}

model User {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  username String @unique
  password String
  role     Role

  // admin-based approval status for this user (PENDING by default, APPROVED/BLOCKED set by admin)
  validation Validation @default(PENDING)

  // all signup form fields except username, password and role (store mapping + user mapping)
  metadata Json?

  abmProfile          ABM?          @relation("UserABM")
  aseProfile          ASE?          @relation("UserASE")
  zbmProfile          ZBM?          @relation("UserZBM")
  zsmProfile          ZSM?          @relation("UserZSM")
  samsungAdminProfile SamsungAdmin? @relation("UserSamsungAdmin")
  zopperAdminProfile  ZopperAdmin?  @relation("UserZopperAdmin")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ABM {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  storeIds String[]
  zbmId    String   @db.ObjectId

  user User @relation("UserABM", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ASE {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  storeIds String[]
  zsmId    String   @db.ObjectId

  user User @relation("UserASE", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ZBM {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  region String?

  user User @relation("UserZBM", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ZSM {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  region   String?

  user User @relation("UserZSM", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SEC {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  fullName    String?
  phone       String    @unique
  secId      String?
  email       String?
  kycInfo     Json?
  lastLoginAt DateTime?
  storeId   String?
  store     Store?    @relation(fields: [storeId], references: [id])
  AgencyName   String?
  SpotIncentiveReport           SpotIncentiveReport[]
  dailyIncentiveReports       DailyIncentiveReport[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Otp {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  phone     String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
}

model SamsungAdmin {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  user User @relation("UserSamsungAdmin", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ZopperAdmin {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId

  fullName String
  phone    String

  user User @relation("UserZopperAdmin", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClaimProcedurePDF {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  fileName    String
  fileSize    Int
  fileData    String // Base64 encoded PDF data
  category    String   @default("GENERAL")
  isActive    Boolean  @default(true)
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}

model PriceIncentiveSlab {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  // Dealer price range for which this incentive applies
  minPrice        Int?     // Minimum price (inclusive)
  maxPrice        Int?     // Maximum price (exclusive or inclusive based on business logic)

  // Base incentive amount for each device in this price range
  incentiveAmount Int      // Example: 500, 438, etc.

  // Threshold logic (per SEC):
  // - gate: Number of units after which incentives start applying.
  // - volumeKicker: Number of units after which 120% incentive applies.
  //
  // Final thresholds are calculated per store:
  // finalGate = gate * store.numberOfSec
  // finalVolumeKicker = volumeKicker * store.numberOfSec
  //
  // STORE-LEVEL CALCULATION:
  // Incentives are calculated for the entire store (all SECs combined),
  // then divided equally among all SECs at that store.
  //
  // Incentive rules (applied to ALL store units):
  // 1. Units < finalGate → No incentive (0%)
  // 2. Units >= finalGate and < finalVolumeKicker → 100% incentive on ALL units
  // 3. Units >= finalVolumeKicker → 120% incentive on ALL units
  // 4. Each SEC's share = Total Store Incentive ÷ numberOfSec
  //
  // Note: Gate and Volume Kicker thresholds are INCLUSIVE (>= comparison)
  gate            Int      // Threshold units per SEC before incentives apply
  volumeKicker    Int      // Units per SEC after which 120% incentive applies

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([minPrice, maxPrice])
}